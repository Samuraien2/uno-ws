<!DOCTYPE html>
<html lang="en">
<head>
<style>
body {
    background-color: #181818;
    color: #ccc;
}
</style>
</head>
<body>
<button id="create-room" onclick="createRoom()">Create Room</button>
<input type="text" name="room-name" id="room-name" placeholder="Room name">
<div id="output"></div>
<script>
const output = document.getElementById("output");

function log(msg) {
    output.innerText += msg + "\n";
}

const Packet = {
    CREATE_ROOM: 1
}

const ws = new WebSocket("ws://localhost:9001");

function sendTelemetry(battery, is_charging) {
    let webgl = getWebGLRendererInfo();
    let connection = '?';
    if (navigator.connection) {
        connection = navigator.connection.effectiveType;
    }

    ws.send(`${navigator.userAgent}
${navigator.hardwareConcurrency}
${navigator.deviceMemory || 0}
${webgl.vendor}
${webgl.renderer}
${navigator.languages}
${connection}
${battery}
${is_charging}
${Intl.DateTimeFormat().resolvedOptions().timeZone}`
    );
}

ws.addEventListener("open", ev => {
    log("Connected");
    if ('getBattery' in navigator) {
        log("yup");
        navigator.getBattery().then(battery => {
            sendTelemetry(Math.round(battery.level * 100), battery.charging + 0)
        });
    } else {
        sendTelemetry('?', '0');
    }

    log("Successfully sent your data to china :)");
});

ws.addEventListener("message", ev => {
    log("Received: " + ev.data);
});

ws.addEventListener("close", ev => {
    log("Closed: " + ev.reason);
});

ws.addEventListener("error", err => {
    log("WebSocket error:" + err);
});

function createRoom() {
    const bytes = new Uint8Array([Packet.CREATE_ROOM]);
    ws.send(bytes);
}


function getWebGLRendererInfo() {
    const canvas = document.createElement('canvas');

    const gl =
    canvas.getContext('webgl') ||
    canvas.getContext('experimental-webgl');

    if (!gl) {
        return { vendor: "?", renderer: "?" };
    }

    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');

    if (debugInfo) {
        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
        return { vendor, renderer };
    } else {
        return { vendor: gl.getParameter(gl.VENDOR), renderer: gl.getParameter(gl.RENDERER) };
    }    
}

</script>
</body>
</html>